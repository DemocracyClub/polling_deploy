{
  "description": "Builds UK Polling Station golden image",
  "variables": {
    "build_region": "eu-west-1",
    "regions_to_copy_to": "eu-central-1",
    "branch": "master",
    "max_spot_price": "0.1"
  },
  "builders": [
    {
      "name": "server",
      "type": "amazon-ebs",
      "ami_name": "ukpollingstations {{isotime |clean_ami_name }}",
      "ami_regions":"{{user `regions_to_copy_to` }}",
      "associate_public_ip_address": true,
      "iam_instance_profile": "packer-ami-builder",
      "instance_type":"m4.large",
      "region": "eu-west-1",
      "region":"{{user `build_region` }}",
      "source_ami": "{{user `imported-db_ami_id`}}",
      "spot_price": "{{ user `max_spot_price`}}",
      "ssh_username": "ubuntu",
      "tags": {
        "build_date":"{{isotime}}"
      },
      "run_tags": {
        "Name": "packer-ami-build"
      }
    },
    {
      "name": "addressbase",
      "type": "amazon-ebs",
      "ami_name": "addressbase {{isotime |clean_ami_name }}",
      "associate_public_ip_address": true,
      "iam_instance_profile": "packer-ami-builder",
      "instance_type":"m4.large",
      "spot_price": "{{ user `max_spot_price`}}",
      "launch_block_device_mappings": [
          {
              "device_name": "/dev/sda1",
              "delete_on_termination": true,
              "volume_size": "20",
              "volume_type": "gp2"
          }
      ],
      "region": "eu-west-1",
      "region":"{{user `build_region` }}",
      "source_ami": "Comment: ubuntu 14.04 hvm:ebs-ssd 20160602",
      "source_ami": "ami-8328bbf0",
      "ssh_username": "ubuntu",
      "tags": {
        "build_date":"{{isotime}}"
      },
      "run_tags": {
        "Name": "packer-ami-build"
      }
    },
    {
      "name": "imported-db",
      "type": "amazon-ebs",
      "ami_name": "ukpollingstations {{isotime |clean_ami_name }}",
      "ami_description": "AMI with Addressbase and Council data pre-imported",
      "associate_public_ip_address": true,
      "iam_instance_profile": "packer-ami-builder",
      "instance_type":"m4.large",
      "region": "eu-west-1",
      "region":"{{user `build_region` }}",
      "source_ami": "{{user `database_ami_id`}}",
      "spot_price": "{{user `max_spot_price`}}",
      "ssh_username": "ubuntu",
      "tags": {
        "build_date":"{{isotime}}"
      },
      "run_tags": {
        "Name": "packer-ami-build"
      }
    }
  ],
  "provisioners": [
    {
      "type": "ansible",
      "only": ["server"],
      "playbook_file": "./provision.yml",
      "groups":["production", "servers", "remote"],
      "extra_arguments": [
        "--extra-vars", "nickname=production packer=1 branch={{user `branch`}}",
        "--extra-vars", "@vault.yml"
      ]
    },
    {
      "type": "shell",
      "only": ["server"],
      "inline": [
        "sudo rm -rf /var/log/cloud-init*.log /home/ubuntu/.ssh/authorized_keys"
      ]
    },
    { "type": "ansible",
      "only": ["addressbase"],
      "playbook_file": "./provision.yml",
      "groups":["production", "servers", "remote"],
      "extra_arguments": [
        "--extra-vars", "nickname=production packer=1 branch=master",
        "--skip-tags", "deploy"
      ]
    },
    {
      "type": "shell",
      "only": ["addressbase"],
      "inline": [
        "/usr/local/bin/aws s3 --region={{ user `build_region` }} cp s3://pollingstations-packer-assets/addressbase/addressbase.sql.tar /tmp/",
        "/usr/local/bin/aws s3 --region={{ user `build_region` }} cp s3://pollingstations-packer-assets/addressbase/addressbase_migrations.sql /tmp/",
        "sudo -u postgres psql  polling_stations -c 'CREATE EXTENSION IF NOT EXISTS postgis;'",
        "cat /tmp/addressbase_migrations.sql | time sudo -u postgres psql polling_stations",
        "time sudo -u postgres pg_restore -d polling_stations --no-owner /tmp/addressbase.sql.tar",
        "sudo rm -rf /var/log/cloud-init*.log /home/ubuntu/.ssh/authorized_keys /tmp/addressbase*"
      ]
    },
    { "type": "ansible",
      "only": ["addressbase"],
      "playbook_file": "./deploy.yml",
      "groups":["production", "servers", "remote"],
      "extra_arguments": [
        "--extra-vars", "nickname=production packer=1 branch=master vault_logger_prod_password=dummy"
      ]
    },
    {
      "type": "file",
      "only": ["imported-db"],
      "source": "files/pg_restore_with_config.sh",
      "destination": "/tmp/pg_restore_fast.sh"
    },
    { "type": "shell",
      "only": ["imported-db"],
      "inline": [
        "sudo mv /tmp/pg_restore_fast.sh /usr/local/sbin/pg_restore_fast.sh && sudo chmod +x /usr/local/sbin/pg_restore_fast.sh",
        "/usr/local/bin/aws s3 --region={{ user `build_region` }} cp s3://pollingstations-packer-assets/database_snapshots/prod_snapshot.sql /tmp/",
        "sudo /usr/local/sbin/pg_restore_fast.sh --disable-triggers --data-only -d polling_stations --no-acl --no-owner --exit-on-error /tmp/prod_snapshot.sql -j4",
        "sudo rm -rf /var/log/cloud-init*.log /home/ubuntu/.ssh/authorized_keys /tmp/prod_snapshot.sql*"
      ]
    }
  ]
}
